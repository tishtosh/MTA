<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="favicon.ico">
    <style>
        body {
            background-color: white;
        }
        ul.a {
            padding-left: 0px;
            margin-left: 0px;
        }
        header {
            margin-left: 0;
            margin-right: 0;
            background-color: red;
        }
        h1 {
            font-size: 30px;
            font-weight: 600;
            color: white;
            background-color: red;
            text-align: center;  
            padding-left: 10px;
            padding-right: 10px;
        }
        h2 {
            font-size: 30px;
            font-weight: 600;
            width: 45px;
            color: white;
            background-color: blue;
            text-align: center;
            display:inline;
            padding-left: 10px;
            padding-right: 10px;
        }
        h3 {
            display:inline;
            padding-left: 10px;
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
        }
        .p1 {
            font-family: Arial, Helvetica, sans-serif;
            margin-left: 5px;
            margin-right: 5px;
            padding-left: 10px;

        }
        pre {
            display:inline;
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
        }

        table {
            width: fit-content;
        }

        tbody td.hme {
            color: white;
            background-color: blue;
            text-align: center;
            width: 100px;
        }
        tbody th {
            width: 800px;
            text-align: center;  
            font-size: 30px;
            font-weight: 600;
            color: white;
            background-color: red;
            text-align: center;     
            --grid-max-width: 21.25rem;
            --grid-gutter: var(--space-s-l, clamp(0.75rem, calc(3.19rem + -3.26vw), 2.50rem));
            --grid-columns: 3;
        }

        tbody td.dme { text-align: center; color:blue; color: white; }

    </style>

    <link href="./css/all.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>

    <title>like a bus</title>
    <meta http-equiv="refresh" content="300">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>    
</head>

<body class="p1">
<p id = "myid"></p>
<pre id="mBus" class="fa-solid fa-bus fa-3x" style="color: #0433ff;" onClick="window.location.reload()" oncontextmenu="getPredictions()">  </pre>
<pre class="fa-solid fa-house fa-3x" onclick="nearURL()" >  </pre>
<pre class="fa-solid fa-location-dot fa-3x" onclick="nearMe()"> </pre>
<pre id="clock" style="font-family: 'Orbitron', sans-serif"></pre>
<pre id="statusmessage"></pre>



<script>
    // MAIN
    //
    // Parameters:
    // busstop : comma delimeted list of busstops to display arrival information for. 
    //          ignore lat lon when busstop is provided
    //          defaults if not provided
    // lat,lon : gps location to search when no busstop is provided

    // URL busstops
    const busstops_default = "1002135,1002130,1002141,1002148";
    var gBusstops = busstops_default.split(",");

    const urlParams = new URLSearchParams(window.location.search);
    const has_stop = urlParams.has('busstop');
    if( has_stop ) {
        gBusstops = urlParams.get('busstop').split(",");
    }
    //console.log( gBusstops );

    // URL lat,lon,radius
    var gLat = 38.89790;        // default to central DC
    var gLon = -77.03661;
    var gRadius = 350;   // Meters
    const has_lat = urlParams.has('lat');
    const has_lon = urlParams.has('lon');
    const has_radius = urlParams.has('radius');
    if( has_lat & has_lon ) {
        gLat = urlParams.get('lat')
        gLon = urlParams.get('lon')
    }
    if( has_radius ) {
        gRadius = urlParams.get('radius');
    }
    console.log( gLat, gLon, gRadius );

    // Element for status message
    var gStatus = document.getElementById("statusmessage");

    // Refresh predicitions for busstops
    getPredictions();

    //
    // FUNCTIONS
    //

    function removeDisplayedStops() {
        // Remove old busstops
        var element;
        while( element = document.getElementById( "t9999" ) ) {
            element.remove(); 
        }
        while( element = gBusstops.pop() )
            ;
        console.log( "Cleared stops:", gBusstops );
    }

    function getStopsNear( lat, lon, radius ) {
        console.log( "GSN start", lat, lon, radius );
        console.log( "GSN stops:", gBusstops );
        
        // Get new busstops
        var params = {
            "api_key": "22a765be4d804e949b016174387d697e",
            "Lat": lat,
            "Lon": lon,
            "Radius": radius,
        };

        var jqStop = $.ajax({
            url: "https://api.wmata.com/Bus.svc/json/jStops?" + $.param(params),
            type: "GET",

        }) .done(function(data) {
            console.log( "GSN have result - clear old display");
            removeDisplayedStops();
            
            var items = []; 
            $(jQuery.parseJSON(JSON.stringify(data.Stops))).each(function() {  
                console.log( this.StopID, this.Name );
                gBusstops.push( this.StopID ); 
            });                
            console.log( "GSN call GP");
            getPredictions();
            console.log( "GSN returned from GP" );

        }) .fail(function(jqStop, textStatus, error) {
            console.log( textStatus, error );
        });

        jqStop.always(function() {
            console.log( "GSN prediction GET complete", gBusstops);
        });

        console.log( "GSN return:", gBusstops );
    }

    function getPredictions() {
        // arrival predictions for gBusstops 
        console.log( "GP start", gBusstops ); 

        for (var i = 0; i < gBusstops.length; i++) { 
            console.log( "GP Getting prediction:", gBusstops[i]); 

            var params = {
                "api_key": "22a765be4d804e949b016174387d697e" ,
                "StopID": gBusstops[i],
            };
                
            var jqPrediction = $.ajax({
                url: "https://api.wmata.com/NextBusService.svc/json/jPredictions?" + $.param(params),
                type: "GET",

            }).done(function(data) {

                var items2=[];
                $(jQuery.parseJSON(JSON.stringify(data.Predictions))).each(function() {  
                    items2.push( this.RouteID, this.Minutes, this.DirectionText );
                });
                
                var s = "<table><tbody><tr><th colspan=4>" + data.StopName + "</th></tr>";
                for (var i = 0; i < items2.length; i=i+3) {
                    s = s + "<tr><td class='hme'>"+ items2[i] + "</td><td>" + items2[i+1] + "</td><td>" + items2[i+2] + "</td></tr>";
                }
                s = s + "</tbody></table>";
                
                var myDiv = document.createElement("table");
                myDiv.id = 't9999';
                myDiv.innerHTML = s;
                document.body.appendChild(myDiv);                
          
            }).fail(function(jqPrediction, textStatus, error) {
                console.log( textStatus, error );
                if( jqPrediction.statusCode() != 429 ) {   // ignore 'too many requests'
                    console.log( jqPrediction.statusCode(), error ) 
                }
            });

            jqPrediction.always(function() {
                console.log( "GP prediction GET complete" );
            });

        }
        console.log( "GP returning", gBusstops );
    };
 
    function nearMe() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showPosition);
        } else { 
            gStatus.innerHTML = "Turn on location sharing.";
        }
    }

    function nearURL() {
        if ( gLat && gLon ) {
            showFixedPosition( gLat, gLon);
        } else { 
            gStatus.innerHTML = "Set the Home location in the URL {lat|lon|radius}";
        }
    }
            
    function showFixedPosition( lat, lon ) {
        console.log( "SFP start", gBusstops );
        getStopsNear( lat, lon, gRadius ); // RUNS ASYNC
        console.log( "SFP return", gBusstops );
        //getPredictions();
    }
        
    function showPosition(position) {
        // getStopsNear( position.coords.latitude, position.coords.longitude );
        console.log( "SP start", gBusstops );
        getStopsNear( position.coords.latitude, position.coords.longitude, 3000 );  // RUNS ASYNC
        console.log( "SP return", gBusstops );
        //removeDisplayedStops();
        //alert( "get predictions");
        //getPredictions();
    }

    // Refresh
    window.setInterval( function () { $('#clock').html(moment().format('H:mm:ss')) }, 30);
</script>
<script src="https://momentjs.com/downloads/moment.js"></script>

<script>
    const div = document.getElementById("mBus");
    div.addEventListener("contextmenu", (e) => {e.preventDefault()});
</script>


</body>
</html>
